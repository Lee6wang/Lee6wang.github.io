---
title: "从脉冲到角度：增量式编码器的原理与实现"
date: 2026-01-27 09:00:00 +0800
categories: [Motor Control, Engineering]
tags: [Encoder]
math: true
---

# 从脉冲到角度：增量式编码器的原理与实现

> 在电机控制系统中，大体可以分为无感和有感两种方式。
> 无感方案通过电流、反电动势等电气量估算转子状态；有感方案则依赖传感器直接测量。
> 增量式编码器是有感方案中最常见的位置反馈装置——结构简单、分辨率高、成本可控。
>
> 最近由于要开始做点电机的工作，本着工欲善其事必先利其器的想法，写点关于电角度和转速测量的东西。后续也会写霍尔、旋变这类传感器的原理及使用方法。
>
> 先感谢网络上各位前辈提供的图，主播就不再重复造轮子了 :)

---

## 一、为什么需要编码器？

在讨论增量式编码器的工作原理之前，先回答一个更根本的问题：

> **电机控制为什么需要编码器？**

---

### 1.1 电机控制的本质：让转子去该去的地方

无论是伺服系统、机器人关节，还是数控机床，电机控制的核心任务都是：

> **控制转子的位置、速度或力矩，使其按期望轨迹运动。**

这意味着控制器必须持续回答两个问题：

1. 转子**现在**在哪里？
2. 转子**现在**转得多快？

没有这两个信息，控制就无从谈起。

---

### 1.2 开环控制的局限

最简单的电机驱动是开环控制：给定电压或 PWM 占空比，期望电机按某种方式旋转。

但问题是：

| 期望     | 实际可能             |
| -------- | -------------------- |
| 恒定转速 | 负载变化导致转速波动 |
| 转动 90° | 惯性导致过冲或欠冲   |
| 静止保持 | 外力扰动导致位置偏移 |

开环系统无法感知这些偏差，因此也无法修正。

> **没有反馈，就没有真正的控制。**

---

### 1.3 闭环控制的需求：反馈

闭环控制的基本结构是：

```
期望值 ──▶ 控制器 ──▶ 执行器 ──▶ 被控对象
              ▲                       │
              │                       ▼
              └───── 传感器 ◀─────────┘
```

传感器的职责是：测量被控对象的实际状态，并将结果反馈给控制器。控制器通过比较"期望"与"实际"，计算出修正指令。

在电机控制中，这个传感器就是**编码器**。

---

### 1.4 编码器的角色：把机械运动变成电信号

电机转子在空间中旋转，这是一个**连续的机械量**。但控制器是数字系统，只能处理**离散的电信号**。

因此，系统需要一个"翻译器"：

> **编码器 = 机械角位移 → 电信号的转换装置**

更准确地说：

```
连续的机械旋转 ──▶ 离散的、可计数的、可辨向的脉冲序列
```

---

### 1.5 为什么不直接测量角度？

你可能会问：为什么不用一个"角度传感器"直接输出角度值？

答案是：**这样的传感器确实存在，但各有取舍。**

| 类型             | 输出            | 特点                                   |
| ---------------- | --------------- | -------------------------------------- |
| 电位器           | 模拟电压 ∝ 角度 | 有磨损、分辨率低、有限圈数             |
| 绝对式编码器     | 数字角度码      | 无需归零，但成本高、结构复杂           |
| 旋转变压器       | 模拟正余弦信号  | 耐高温、抗振动，但需解码电路           |
| **增量式编码器** | 脉冲序列        | 结构简单、成本低、高分辨率、无圈数限制 |

增量式编码器之所以广泛使用，正是因为它在**成本、分辨率、可靠性**之间取得了很好的平衡。

---

### 1.6 增量式编码器的"哲学"

增量式编码器的设计思想可以概括为：

> **不记录"你在哪"，只记录"你动了多少"。**

它不存储绝对位置，而是：每发生一定量的角位移，输出一个脉冲，由控制器累加这些脉冲来计算位置。

这种设计带来几个特性：

| 特性     | 含义                         |
| -------- | ---------------------------- |
| 相对性   | 断电后位置信息丢失           |
| 无限圈数 | 没有机械限位，可无限旋转     |
| 高分辨率 | 刻线数可做到数千甚至上万 PPR |
| 低成本   | 结构简单，易于制造           |

---

## 二、增量式编码器（ABZ）的工作原理

![编码器结构示意图](../assets/figure/2026-01-26/1.png)

### 2.1 编码器的输入是什么？——机械角位移

增量式编码器连接在电机转轴上，其**唯一的物理输入量**是：

> **转轴的机械角位移 $\theta_m$**

编码器本身不具备任何"角度记忆"或"角度基准"，它只能感知**转轴是否发生了位移，以及位移的相对变化**。

因此，编码器的首要任务不是"测角度"，而是：

> **把连续的角位移，转换成可被检测的周期性变化。**

---

### 2.2 如何把连续角位移变成"可检测事件"？——刻线码盘

为实现这一点，编码器在转轴上固定一块**刻有等间距透光/不透光结构的码盘**：

- 转轴旋转时，码盘同步旋转
- 每经过一个刻线周期，光路状态发生一次变化

于是，连续角位移被转换为**周期性的光通/光断事件**。

此时，编码器完成了第一步抽象：

> **$\theta_m$（连续）→ 周期性物理事件**

刻线数量决定了**每转产生多少次事件**，即 PPR（Pulses Per Revolution）。

---

### 2.3 如何把"物理事件"变成电信号？——光电转换与整形

码盘本身不产生电信号，因此编码器内部还包含：

- 发光器件（LED）
- 光电接收器
- 放大与整形电路

工作链路如下：

1. LED 提供稳定光源
2. 码盘旋转调制光通量
3. 光电接收器输出模拟电信号
4. 经放大、比较、整形后
5. 输出数字电平变化

至此，系统完成了第二步抽象：

> **周期性物理事件 → 数字脉冲信号**

如果只做到这一步，编码器只能输出**一路脉冲**。

---

### 2.4 为什么"一路脉冲"不够？——方向信息缺失

设想只有一路脉冲信号：每出现一个脉冲，说明"转轴发生了一定角位移"，但**无法判断转动方向**。

也就是说：

> 单通道脉冲只能表达 $|\Delta\theta_m|$，而非 $\Delta\theta_m$

在电机控制中，**方向是必须的信息**。因此，编码器必须引入一个新的信息维度。

---

### 2.5 方向信息如何引入？——正交的 A/B 两相信号

编码器在同一刻线圆周上布置**两组光电接收器**：

- 空间位置错开 **1/4 刻线周期**
- 因此输出信号在时间上错开 **90° 相位**

于是得到：

- **A 相**：周期脉冲
- **B 相**：同频率，相位滞后（或超前）90° 的脉冲

这样，系统完成了第三步抽象：

> **相对位移 + 相位先后关系 → 位移方向**

方向判断来自**物理上的相位先后关系**：

- A 领先 B → 正转
- B 领先 A → 反转

---

### 2.6 A/B 相真正提供的是什么信息？

需要强调的是：

- A/B 相**并不直接给出角度**
- 它们提供的是：位移发生的**次数**和**方向**

因此，编码器输出的本质信息是：

> **$\Delta\theta_m$ 的符号化、量化表达**

角度本身，是控制系统通过**计数与累加**计算出来的。

---

### 2.7 为什么还需要 Z 相？——周期参考点缺失

到目前为止：

- A/B 相可以累积位移
- 但系统仍然不知道："现在是第几圈？"、"这个计数对应的是哪一圈的位置？"

这意味着：

> **系统缺少一个"机械周期参考点"**

为解决这一问题，编码器在码盘上额外设计了一条**仅有一个透光窗口的 Z 环**：

- 每机械转一圈，仅输出一次脉冲

于是：

- **Z 相提供的是转动周期的绝对参考**，而非分辨率

---

### 2.8 A/B/Z 三相信号的逻辑分工

到这里，三路信号的角色已经完全清晰：

| 信号       | 作用                       |
| ---------- | -------------------------- |
| **A/B 相** | 表达相对位移与方向         |
| **Z 相**   | 表达"转了一整圈"的参考事件 |

编码器本身仍然**不存储角度**，但它为控制系统提供了：

> **构建角度所需的全部原始信息**

---

### 2.9 从编码器信号到控制量

在控制器中：

1. A/B 边沿 → 计数器 ±1
2. 累计计数 → 相对机械角度
3. 相邻采样周期的计数差 → 转速
4. Z 相 → 计数校准/对齐参考

需要注意的是：

> **角度与转速不是编码器"给"的，而是系统"算"的。**

---

## 三、真实系统中的实现

前两章建立了增量式编码器的信号逻辑。本章讨论：

> **在实际硬件与软件中，如何把 A/B/Z 信号转化为可用的角度和转速？**

---

### 3.1 硬件接口：信号如何进入控制器？

在 48V 级别的电机应用中（电动车、机器人、无人机等），编码器通常直接与 MCU 连接，接口以 **TTL/CMOS 电平**为主。

**常见接口类型**

| 类型           | 电平     | 典型场景                                |
| -------------- | -------- | --------------------------------------- |
| TTL            | 5V       | 传统编码器，需确认 MCU 引脚是否 5V 容忍 |
| CMOS           | 3.3V     | 直接对接 STM32 等主流 MCU               |
| 差分（RS-422） | 差分信号 | 线缆较长（>1m）或电机侧干扰严重时选用   |

> 48V 系统中，功率级的 PWM 开关噪声是主要干扰源，但由于线缆通常较短（<50cm），单端 TTL/CMOS 接口在多数情况下够用。

**接线要点**

1. **电源**：编码器供电通常为 5V，从控制板取电即可；注意与电机驱动的功率地隔离或单点共地
2. **信号线**：A/B/Z 三根信号线 + GND，建议使用带屏蔽的多芯线
3. **滤波**：MCU 输入端可串联 100Ω 电阻 + 对地 1nF 电容，构成简单的 RC 低通滤波

```c
编码器侧          控制板侧
  A ──────[100Ω]───┬─── TIM_CH1
                   │
                 [1nF]
                   │
 GND ──────────────┴─── GND
```

**差分接口的使用场景**

如果出现以下情况，建议升级为差分接口（RS-422）：

- 编码器线缆长度 > 1m
- 编码器走线靠近大电流母线或 MOS 管
- 静止时计数器频繁跳动

差分接收芯片（如 AM26C32、MAX485）将差分信号转为单端 TTL，再送入 MCU。

**实际踩坑提醒**

| 问题                 | 原因                                    | 解决                             |
| -------------------- | --------------------------------------- | -------------------------------- |
| 上电后计数乱跳       | 编码器 5V 供电，MCU 为 3.3V，电平不匹配 | 加电平转换或选用 3.3V 编码器     |
| 高速时丢脉冲         | 信号上升沿变缓，边沿识别失败            | 缩短线缆、降低滤波电容、检查接地 |
| 电机一转动就计数异常 | PWM 开关噪声耦合                        | 屏蔽线、单点接地、远离功率线     |

---

### 3.2 计数方式：1×/2×/4× 倍频

A/B 两相信号的边沿可被不同方式计数：

| 倍频模式 | 计数触发条件        | 每周期计数 |
| -------- | ------------------- | ---------- |
| 1×       | 仅 A 相上升沿       | 1          |
| 2×       | A 相上升沿 + 下降沿 | 2          |
| 4×       | A/B 双相所有边沿    | 4          |

以 1000 PPR 编码器为例：

- 1× 模式 → 每圈 1000 计数
- 4× 模式 → 每圈 4000 计数

> **倍频提高了分辨率，但不改变编码器的物理刻线数。**

注意：倍频越高，对信号质量和处理速度的要求也越高。

---

### 3.3 硬件实现：定时器的正交解码模式

现代 MCU（如 STM32）的高级定时器通常内置**正交编码器接口**：

![2](../assets/figure/2026-01-26/2.png)

配置示例（STM32 HAL）：

```c
TIM_Encoder_InitTypeDef encoder_config = {
    .EncoderMode  = TIM_ENCODERMODE_TI12,   // 4× 倍频
    .IC1Polarity  = TIM_ICPOLARITY_RISING,
    .IC1Selection = TIM_ICSELECTION_DIRECTTI,
    .IC1Filter    = 0x0F,                   // 输入滤波，抑制毛刺
    .IC2Polarity  = TIM_ICPOLARITY_RISING,
    .IC2Selection = TIM_ICSELECTION_DIRECTTI,
    .IC2Filter    = 0x0F,
};

HAL_TIM_Encoder_Init(&htim3, &encoder_config);
HAL_TIM_Encoder_Start(&htim3, TIM_CHANNEL_ALL);
```

硬件解码的优势：

- **零 CPU 开销**：计数完全由硬件完成
- **不丢脉冲**：即使 CPU 忙于其他任务
- **自动方向判断**：计数器自动加减

---

### 3.4 计数器溢出处理：扩展到多圈

16 位计数器范围是 0～65535。对于 4000 计数/圈的配置：

> 65535 ÷ 4000 ≈ 16 圈后溢出

解决方案是**软件扩展**：

```c
volatile int32_t  total_count = 0;
volatile uint16_t last_count  = 0;

// 定时调用（如 1kHz）
void update_position(void) {
    uint16_t current = __HAL_TIM_GET_COUNTER(&htim3);
    int16_t  delta   = (int16_t)(current - last_count);
    total_count += delta;
    last_count   = current;
}
```

关键点：

- `int16_t` 强制转换自动处理上溢/下溢的回绕
- 调用频率必须足够高，保证 `|delta| < 32768`

---

### 3.5 Z 相的使用：归零与校准

Z 相脉冲的典型用途：

1. **上电归零**：电机缓慢旋转，检测到 Z 后将计数器清零
2. **累计误差校准**：每次检测到 Z，验证计数是否为 `PPR × 4` 的整数倍
3. **绝对位置恢复**：配合记忆的圈数，重建绝对角度

Z 相检测通常使用**外部中断**：

```c
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
    if (GPIO_Pin == Z_PHASE_PIN) {
        int32_t expected = rounds * PPR * 4;
        int32_t actual   = total_count;
        
        if (abs(actual - expected) > TOLERANCE) {
            // 记录误差或触发报警
        }
    }
}
```

---

### 3.6 从计数到物理量：角度与转速

**机械角度**计算：

```c
#define COUNTS_PER_REV  (1000 * 4)  // PPR=1000, 4× 倍频

float get_angle_rad(void) {
    return (float)total_count / COUNTS_PER_REV * 2.0f * M_PI;
}

float get_angle_deg(void) {
    return (float)total_count / COUNTS_PER_REV * 360.0f;
}
```

**转速**计算（差分法）：

```c
int32_t prev_count = 0;
float   dt = 0.001f;  // 1ms 采样周期

float get_speed_rpm(void) {
    int32_t delta = total_count - prev_count;
    prev_count = total_count;
    
    // delta / COUNTS_PER_REV = 圈数
    // 圈数 / dt = 圈/秒
    // × 60 = RPM
    return (float)delta / COUNTS_PER_REV / dt * 60.0f;
}
```

> **提示**：高速时差分法精度高；低速时可考虑**周期测量法**（测相邻脉冲的时间间隔）。

---

### 3.7 信号质量问题与对策

实际系统中的常见问题：

| 问题       | 现象               | 对策                              |
| ---------- | ------------------ | --------------------------------- |
| 电磁干扰   | 计数跳变、方向误判 | 差分接口、屏蔽线、输入滤波        |
| 信号毛刺   | 静止时计数抖动     | 硬件滤波器（IC1Filter）、软件去抖 |
| 接线松动   | 间歇性丢脉冲       | 检查连接器、使用航空插头          |
| 电平不匹配 | 无法识别边沿       | 确认电平标准、必要时加电平转换    |

诊断方法：

- 示波器观察 A/B 波形是否干净、正交
- 低速手动旋转，检查计数是否稳定
- 监测 Z 相校验误差

---

### 3.8 软件架构建议

一个典型的编码器处理模块结构：

![3](../assets/figure/2026-01-26/3.png)

分层的好处：

- 更换编码器型号时，只需修改驱动层
- 应用层代码可复用
- 便于单元测试

---

### 3.9 本章小结

真实系统的实现要点：

1. **接口选择**：根据距离、干扰、速度选择合适的电气接口
2. **硬件解码**：优先使用 MCU 定时器的正交模式
3. **溢出处理**：软件扩展实现多圈累计
4. **Z 相利用**：归零校准，消除累计误差
5. **信号质量**：滤波、屏蔽、正确接线

> **编码器只是信息的入口，真正的角度存在于软件的计数器里。**

---

## 写在最后

增量式编码器的设计很美：用最朴素的物理原理（光通/光断）和最基本的信号形式（脉冲），构建出一套完整的位置反馈体系。

理解了 A/B/Z 三相信号的本质，再去看硬件手册、写驱动代码，就不再是"照抄配置"，而是"知其所以然"。
